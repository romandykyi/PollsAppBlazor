@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using PollsAppBlazor.Client.Auth
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar
@inject TokenService TokenService

<AuthorizeView>
	<Authorized>
		Hello, @context.User.Identity?.Name!
		<button class="nav-link btn btn-link" @onclick="LogOut">Log out</button>
	</Authorized>
	<NotAuthorized>
		<a href="/users/register">Register</a>
		<a href="/users/login">Log in</a>
	</NotAuthorized>
</AuthorizeView>

@code {
	private async Task LogOut()
	{
		var parameters = new DialogParameters<DialogTemplate>();
		parameters.Add(x => x.ContentText, "Are you sure you want to Log out?");
		parameters.Add(x => x.Color, Color.Error);

		DialogOptions options = new() { Position = DialogPosition.TopCenter };

		var dialog = await DialogService.ShowAsync<DialogTemplate>("Log out confirmation", parameters, options);
		var result = await dialog.Result;

		if (result == null || result.Canceled) return;

		var client = HttpClientFactory.CreateClient(HttpClientName.AuthApiClientName);
		var httpResponse = await client.PostAsync("/api/auth/logout", null);
		try
		{
			httpResponse.EnsureSuccessStatusCode();

			TokenService.Clear();
			NavigationManager.NavigateTo("/", true);
			StateHasChanged();

		}
		catch (HttpRequestException)
		{
			Snackbar.UnexpectedError();
		}
	}
}
