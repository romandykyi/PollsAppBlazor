@page "/polls/"
@using System.Net.Http.Json
@using PollsAppBlazor.Shared.Polls
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject PublicClient PublicClient
@inject NavigationManager NavigationManager

<MudDataGrid 
	T="PollPreviewDto" Items="@polls" Filterable="false" SortMode="@SortMode.None" 
	Groupable="false" RowClick="SelectPoll">
	<Columns>
		<PropertyColumn Property="p => p!.Title" />
		<PropertyColumn Property="p => p!.Creator" Title="Published by" />
		<PropertyColumn Property="p => p!.CreationDate.AsTimeAgo()" Title="Published" />
	</Columns>
</MudDataGrid>

@code {
	public IEnumerable<PollPreviewDto>? polls;

	private void SelectPoll(DataGridRowClickEventArgs<PollPreviewDto> e)
	{
		NavigationManager.NavigateTo($"/polls/{e.Item.Id}");
	}

	protected override async Task OnInitializedAsync()
	{
		try
		{
			polls = await PublicClient.Client.GetFromJsonAsync<IEnumerable<PollPreviewDto>>("/api/polls");
		}
		catch (AccessTokenNotAvailableException exception)
		{
			exception.Redirect();
		}
	}
}
